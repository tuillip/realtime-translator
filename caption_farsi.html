<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8" />
<title>Farsi Captions</title>

<style>
  html, body {
    margin: 0;
    height: 100%;
    background: #111;
    color: #f5f5f5;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    direction: rtl;
  }

  .wrap {
    padding: 4vh 4vw;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    box-sizing: border-box;
  }

  #lines {
    display: flex;
    flex-direction: column;
    gap: 0.6em;
    font-size: clamp(28px, 5vw, 50px);
    line-height: 1.35;
    text-align: right;
    width: 100%;
    word-wrap: break-word;
  }

  .final-line {
    opacity: 0.9;
  }

  .active-line {
    opacity: 1;
    font-weight: 500;
  }
</style>
</head>

<body>
<div class="wrap">
  <div id="lines"></div>
</div>

<script>
const linesEl = document.getElementById("lines");
const MAX_LINES = 6;

let committed = [];   // Always final lines
let activeLine = "";  // Real-time partial

function render() {
  linesEl.innerHTML = "";

  // Show committed lines
  committed.forEach(line => {
    const div = document.createElement("div");
    div.className = "final-line";
    div.textContent = line;
    linesEl.appendChild(div);
  });

  // Show live partial line
  if (activeLine) {
    const div = document.createElement("div");
    div.className = "active-line";
    div.textContent = activeLine;
    linesEl.appendChild(div);
  }
}

function updateCommitted(newLines) {
  committed = newLines.slice(-MAX_LINES);
  activeLine = "";
  render();
}

function updateActive(text) {
  activeLine = text.trim();
  render();
}

// -------------------------------
const host = window.location.hostname || "localhost";
const ws = new WebSocket("ws://" + host + ":8765");

ws.onopen = () => {
  console.log("Connected to caption server");
};

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);

  if (data.type === "state" && Array.isArray(data.lines)) {
    updateCommitted(data.lines);
  }

  if (data.type === "active") {
    updateActive(data.text || "");
  }
};

ws.onclose = () => {
  activeLine = "ارتباط قطع شد";
  render();
};
</script>
</body>
</html>
